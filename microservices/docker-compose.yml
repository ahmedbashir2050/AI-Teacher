version: '3.8'

services:
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - api-gateway
    networks:
      - ai-teacher-network

  db-auth:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-user:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-chat:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: chat_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-rag:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: rag_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-exam:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: exam_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-library:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: library_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  db-pro-exam:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: pro_exam_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    networks:
      - ai-teacher-network

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    networks:
      - ai-teacher-network

  qdrant:
    image: qdrant/qdrant:latest
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    networks:
      - ai-teacher-network

  pgbouncer:
    image: edoburu/pgbouncer
    environment:
      - DATABASE_URL=postgresql://user:password@db-auth:5432/auth_db
      - MAX_CLIENT_CONN=10000
      - DEFAULT_POOL_SIZE=20
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
    depends_on:
      - db-auth
      - db-user
      - db-chat
      - db-rag
      - db-exam
      - db-library
      - db-pro-exam
    networks:
      - ai-teacher-network

  api-gateway:
    image: my-docker-org/ai-teacher-api-gateway:latest
    build:
      context: ./api-gateway
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      JWT_ISSUER: ${JWT_ISSUER}
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_URL: http://auth-service:8000
      USER_SERVICE_URL: http://user-service:8000
      CHAT_SERVICE_URL: http://chat-service:8000
      RAG_SERVICE_URL: http://rag-service:8000
      EXAM_SERVICE_URL: http://exam-service:8000
      PRO_EXAM_SERVICE_URL: http://pro-exam-service:8000
      LIBRARY_SERVICE_URL: http://library-service:8000
    depends_on:
      - redis
    networks:
      - ai-teacher-network

  auth-service:
    image: my-docker-org/ai-teacher-auth-service:latest
    build:
      context: ./auth-service
    deploy:
      replicas: 2
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/auth_db
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      JWT_ISSUER: ${JWT_ISSUER}
    depends_on:
      - db-auth
    networks:
      - ai-teacher-network

  user-service:
    image: my-docker-org/ai-teacher-user-service:latest
    build:
      context: ./user-service
    deploy:
      replicas: 2
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/user_db
    depends_on:
      - db-user
    networks:
      - ai-teacher-network

  chat-service:
    image: my-docker-org/ai-teacher-chat-service:latest
    build:
      context: ./chat-service
    deploy:
      replicas: 5
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/chat_db
      REDIS_URL: redis://redis:6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RAG_SERVICE_URL: http://rag-service:8000
    depends_on:
      - db-chat
      - redis
    networks:
      - ai-teacher-network

  rag-service:
    image: my-docker-org/ai-teacher-rag-service:latest
    build:
      context: ./rag-service
    deploy:
      replicas: 5
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/rag_db
      QDRANT_URL: http://qdrant:6333
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
    depends_on:
      - db-rag
      - qdrant
      - redis
    networks:
      - ai-teacher-network

  exam-service:
    image: my-docker-org/ai-teacher-exam-service:latest
    build:
      context: ./exam-service
    deploy:
      replicas: 3
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/exam_db
      RAG_SERVICE_URL: http://rag-service:8000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db-exam
      - redis
    networks:
      - ai-teacher-network

  exam-worker:
    image: my-docker-org/ai-teacher-exam-service:latest
    build:
      context: ./exam-service
    command: celery -A tasks.celery_app worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/exam_db
      RAG_SERVICE_URL: http://rag-service:8000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db-exam
      - redis
    networks:
      - ai-teacher-network

  pro-exam-service:
    image: my-docker-org/ai-teacher-pro-exam-service:latest
    build:
      context: ./pro-exam-service
    deploy:
      replicas: 2
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/pro_exam_db
      RAG_SERVICE_URL: http://rag-service:8000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      JWT_ISSUER: ${JWT_ISSUER}
    depends_on:
      - db-pro-exam
      - redis
    networks:
      - ai-teacher-network

  pro-exam-worker:
    image: my-docker-org/ai-teacher-pro-exam-service:latest
    build:
      context: ./pro-exam-service
    command: celery -A tasks.exam_tasks.celery_app worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/pro_exam_db
      RAG_SERVICE_URL: http://rag-service:8000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - db-pro-exam
      - redis
    networks:
      - ai-teacher-network

  rag-worker:
    image: my-docker-org/ai-teacher-rag-service:latest
    build:
      context: ./rag-service
    command: celery -A tasks.celery_app worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/rag_db
      QDRANT_URL: http://qdrant:6333
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
    depends_on:
      - db-rag
      - qdrant
      - redis
    networks:
      - ai-teacher-network

  notification-service:
    image: my-docker-org/ai-teacher-notification-service:latest
    build:
      context: ./notification-service
    environment:
      REDIS_URL: redis://redis:6379/0
    networks:
      - ai-teacher-network

  library-service:
    image: my-docker-org/ai-teacher-library-service:latest
    build:
      context: ./library-service
    deploy:
      replicas: 2
    environment:
      DATABASE_URL: postgresql://user:password@pgbouncer:6432/library_db
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      JWT_ISSUER: ${JWT_ISSUER}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
    depends_on:
      - db-library
      - redis
    networks:
      - ai-teacher-network

  notification-worker:
    image: my-docker-org/ai-teacher-notification-service:latest
    build:
      context: ./notification-service
    command: celery -A tasks.celery_app worker --loglevel=info
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - redis
    networks:
      - ai-teacher-network

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - ai-teacher-network

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - ai-teacher-network

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    networks:
      - ai-teacher-network

networks:
  ai-teacher-network:
    driver: bridge
